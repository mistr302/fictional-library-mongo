<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Školní knihovna</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { padding-top: 20px; }
        .nav-tabs { margin-bottom: 20px; }
        .book-card { margin-bottom: 15px; border-left: 4px solid #007bff; }
        .loan-active { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .btn-sm { margin-right: 5px; }

        /* Custom modal styles */
        .modal.custom-modal {
            display: none;
        }

        .modal-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1051; /* Higher than Bootstrap's default modals */
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-backdrop.fade {
            opacity: 0;
            transition: opacity 0.15s linear;
        }

        .modal-backdrop.fade.show {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Školní knihovna</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="books-tab" data-bs-toggle="tab" data-bs-target="#books" type="button" role="tab">Knihy</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="physical-books-tab" data-bs-toggle="tab" data-bs-target="#physical-books" type="button" role="tab">Fyzické kopie</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="loans-tab" data-bs-toggle="tab" data-bs-target="#loans" type="button" role="tab">Výpůjčky</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="book-history-tab" data-bs-toggle="tab" data-bs-target="#book-history" type="button" role="tab">Historie knih</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="readers-tab" data-bs-toggle="tab" data-bs-target="#readers" type="button" role="tab">Čtenáři</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Books Tab -->
            <div class="tab-pane fade show active" id="books" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" id="book-search" class="form-control" placeholder="Hledat knihu...">
                    </div>
                    <div class="col-md-4">
                        <select id="genre-filter" class="form-select">
                            <option value="">Všechny žánry</option>
                            <option value="román">Román</option>
                            <option value="poezie">Poezie</option>
                            <option value="drama">Drama</option>
                            <option value="encyklopedie">Encyklopedie</option>
                            <option value="učebnice">Učebnice</option>
                            <option value="sci-fi">Sci-fi</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="add-book-btn" class="btn btn-primary w-100">Přidat knihu</button>
                    </div>
                </div>
                
                <div id="books-list" class="row">
                    <!-- Books will be loaded here -->
                </div>
                
                <!-- Add/Edit Book Modal -->
                <div class="modal fade" id="bookModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="bookModalLabel">Přidat knihu</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="book-form">
                                    <input type="hidden" id="book-id">
                                    <div class="mb-3">
                                        <label for="book-title" class="form-label">Název</label>
                                        <input type="text" class="form-control" id="book-title" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="book-author" class="form-label">Autor</label>
                                        <input type="text" class="form-control" id="book-author" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="book-year" class="form-label">Rok vydání</label>
                                        <input type="number" class="form-control" id="book-year" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="book-genre" class="form-label">Žánr</label>
                                        <input type="text" class="form-control" id="book-genre" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="book-total" class="form-label">Celkové kopie</label>
                                        <input type="number" class="form-control" id="book-total" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavřít</button>
                                <button type="button" class="btn btn-primary" id="save-book-btn">Uložit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Physical Books Tab -->
            <div class="tab-pane fade" id="physical-books" role="tabpanel">
                <h3>Fyzické kopie knih</h3>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <select id="physical-book-book-select" class="form-select">
                            <option value="">Vyberte hlavní knihu...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="load-physical-books-btn" class="btn btn-primary w-100">Načíst</button>
                    </div>
                    <div class="col-md-4">
                        <button id="add-physical-book-btn" class="btn btn-success w-100">Přidat fyzickou kopii</button>
                    </div>
                </div>

                <div id="physical-books-container">
                    <!-- Physical books will be loaded here -->
                </div>

                <!-- Add Physical Book Modal -->
                <div class="modal fade" id="physicalBookModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="physicalBookModalLabel">Přidat fyzickou kopii</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="physical-book-form">
                                    <input type="hidden" id="physical-book-parent-id">
                                    <input type="hidden" id="physical-book-id">
                                    <div class="mb-3">
                                        <label for="physical-book-state" class="form-label">Stav</label>
                                        <select class="form-select" id="physical-book-state" required>
                                            <option value="new">Nová</option>
                                            <option value="like_new">Jako nová</option>
                                            <option value="good" selected>Dobrá</option>
                                            <option value="acceptable">Přijatelná</option>
                                            <option value="poor">Slabá</option>
                                            <option value="damaged">Poškozená</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="physical-book-status" class="form-label">Stav dostupnosti</label>
                                        <select class="form-select" id="physical-book-status" required>
                                            <option value="available" selected>Dostupná</option>
                                            <option value="borrowed">Vypůjčená</option>
                                            <option value="damaged">Poškozená</option>
                                            <option value="lost">Ztracená</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavřít</button>
                                <button type="button" class="btn btn-primary" id="save-physical-book-btn">Uložit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Physical Book History Modal -->
                <div class="modal fade" id="physicalBookHistoryModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Historie fyzické kopie</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="physical-book-history-content">
                                    <!-- History will be loaded here -->
                                </div>

                                <div class="mt-4">
                                    <h6>Změnit stav fyzické kopie</h6>
                                    <div class="row">
                                        <div class="col-md-5">
                                            <select class="form-select" id="change-physical-book-state">
                                                <option value="new">Nová</option>
                                                <option value="like_new">Jako nová</option>
                                                <option value="good" selected>Dobrá</option>
                                                <option value="acceptable">Přijatelná</option>
                                                <option value="poor">Slabá</option>
                                                <option value="damaged">Poškozená</option>
                                            </select>
                                        </div>
                                        <div class="col-md-5">
                                            <select class="form-select" id="change-physical-book-status">
                                                <option value="available">Dostupná</option>
                                                <option value="borrowed">Vypůjčená</option>
                                                <option value="damaged">Poškozená</option>
                                                <option value="lost">Ztracená</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button id="update-physical-book-state-btn" class="btn btn-primary w-100">Upravit</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavřít</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loans Tab -->
            <div class="tab-pane fade" id="loans" role="tabpanel">
                <h3>Seznam výpůjček</h3>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5>Vypůjčit knihu</h5>
                                <form id="loan-form">
                                    <div class="mb-3">
                                        <label for="loan-book" class="form-label">Vybrat knihu</label>
                                        <select class="form-select" id="loan-book" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="loan-reader" class="form-label">Vybrat čtenáře</label>
                                        <select class="form-select" id="loan-reader" required></select>
                                    </div>
                                    <button type="submit" class="btn btn-success">Vypůjčit</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5>Historie výpůjček</h5>
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="history-reader-select" class="form-label">Vybrat čtenáře</label>
                                        <select class="form-select" id="history-reader-select">
                                            <option value="">Vyberte čtenáře...</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="reader-loans-history">
                                    <p>Vyberte čtenáře pro zobrazení historie jeho výpůjček</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h5>Aktuálně vypůjčené knihy</h5>
                        <div id="active-loans-list">
                            <!-- Active loans will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Book History Tab -->
            <div class="tab-pane fade" id="book-history" role="tabpanel">
                <h3>Historie a stav knihy</h3>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="book-history-select" class="form-label">Vybrat knihu</label>
                                        <select class="form-select" id="book-history-select">
                                            <option value="">Vyberte knihu...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button id="view-book-history-btn" class="btn btn-primary w-100">Zobrazit historii</button>
                                    </div>
                                </div>


                                <div id="book-loans-history">
                                    <p>Vyberte knihu a klikněte na "Zobrazit historii" pro zobrazení historie této knihy</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Readers Tab -->
            <div class="tab-pane fade" id="readers" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-10">
                        <input type="text" id="reader-search" class="form-control" placeholder="Hledat čtenáře...">
                    </div>
                    <div class="col-md-2">
                        <button id="add-reader-btn" class="btn btn-primary w-100">Přidat čtenáře</button>
                    </div>
                </div>
                
                <div id="readers-list" class="row">
                    <!-- Readers will be loaded here -->
                </div>
                
                <!-- Add/Edit Reader Modal -->
                <div class="modal fade" id="readerModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="readerModalLabel">Přidat čtenáře</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="reader-form">
                                    <input type="hidden" id="reader-id">
                                    <div class="mb-3">
                                        <label for="reader-name" class="form-label">Jméno</label>
                                        <input type="text" class="form-control" id="reader-name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="reader-class" class="form-label">Třída</label>
                                        <input type="text" class="form-control" id="reader-class" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="reader-email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="reader-email" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavřít</button>
                                <button type="button" class="btn btn-primary" id="save-reader-btn">Uložit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Reusable Alert/Confirm/Prompt Modals
        class ModalManager {
            constructor() {
                this.modalContainer = null;
                this.createModalContainer();
            }

            createModalContainer() {
                // Create the modal container if it doesn't exist
                if (document.getElementById('custom-modal-container')) {
                    this.modalContainer = document.getElementById('custom-modal-container');
                    return;
                }

                this.modalContainer = document.createElement('div');
                this.modalContainer.id = 'custom-modal-container';
                this.modalContainer.setAttribute('aria-hidden', 'true');
                this.modalContainer.innerHTML = `
                    <div id="custom-modal-overlay" class="modal-backdrop fade" style="display: none;" aria-hidden="true"></div>
                    <div id="custom-modal-wrapper" class="modal-wrapper" style="display: none;" aria-hidden="true">
                        <div id="custom-modal" class="modal custom-modal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="custom-modal-title" aria-describedby="custom-modal-message">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 id="custom-modal-title" class="modal-title">Upozornění</h5>
                                        <button type="button" class="btn-close" aria-label="Zavřít"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p id="custom-modal-message"></p>
                                        <div id="custom-modal-input-container" class="mt-3" style="display: none;" role="group" aria-label="Vstupní pole">
                                            <input type="text" id="custom-modal-input" class="form-control" placeholder="Zadejte hodnotu..." autocomplete="off">
                                        </div>
                                    </div>
                                    <div class="modal-footer" id="custom-modal-footer">
                                        <button id="custom-modal-cancel-btn" type="button" class="btn btn-secondary">Zrušit</button>
                                        <button id="custom-modal-confirm-btn" type="button" class="btn btn-primary">OK</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(this.modalContainer);

                // Setup event listeners
                this.setupEventListeners();
            }

            setupEventListeners() {
                const modalElement = document.getElementById('custom-modal');
                const overlay = document.getElementById('custom-modal-overlay');
                const wrapper = document.getElementById('custom-modal-wrapper');

                // Close on backdrop click
                overlay.addEventListener('click', () => {
                    this.closeModal();
                });

                // Close on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && wrapper.style.display !== 'none') {
                        this.closeModal();
                    }
                });

                // Button click handlers
                document.getElementById('custom-modal-cancel-btn').addEventListener('click', () => {
                    this.handleCancel();
                });

                document.getElementById('custom-modal-confirm-btn').addEventListener('click', () => {
                    this.handleConfirm();
                });

                // Close button handler
                document.querySelector('#custom-modal .btn-close').addEventListener('click', () => {
                    this.closeModal();
                });
            }

            // Private variables to store resolve/reject functions
            resolveCallback = null;
            rejectCallback = null;
            modalType = null; // 'alert', 'confirm', 'prompt'

            showAlert(message, title = 'Upozornění') {
                return new Promise((resolve) => {
                    this.resolveCallback = resolve;
                    this.modalType = 'alert';

                    this.updateModalContent(title, message, 'alert');
                    this.showModal();
                });
            }

            showConfirm(message, title = 'Potvrzení') {
                return new Promise((resolve) => {
                    this.resolveCallback = resolve;
                    this.rejectCallback = null;
                    this.modalType = 'confirm';

                    this.updateModalContent(title, message, 'confirm');
                    this.showModal();
                });
            }

            showPrompt(message, title = 'Vstup', defaultValue = '') {
                return new Promise((resolve) => {
                    this.resolveCallback = resolve;
                    this.modalType = 'prompt';

                    this.updateModalContent(title, message, 'prompt', defaultValue);
                    this.showModal();
                });
            }

            updateModalContent(title, message, type, defaultValue = '') {
                const modalTitle = document.getElementById('custom-modal-title');
                const modalMessage = document.getElementById('custom-modal-message');
                const inputContainer = document.getElementById('custom-modal-input-container');
                const inputField = document.getElementById('custom-modal-input');
                const footer = document.getElementById('custom-modal-footer');
                const cancelButton = document.getElementById('custom-modal-cancel-btn');
                const confirmButton = document.getElementById('custom-modal-confirm-btn');

                modalTitle.textContent = title;
                modalMessage.innerHTML = message.replace(/\n/g, '<br>'); // Support for newlines

                // Show/hide input field based on type
                if (type === 'prompt') {
                    inputContainer.style.display = 'block';
                    inputField.value = defaultValue;
                    inputField.focus();
                } else {
                    inputContainer.style.display = 'none';
                    inputField.value = '';
                }

                // Configure buttons based on type
                if (type === 'alert') {
                    // Alert: only OK button
                    cancelButton.style.display = 'none';
                    confirmButton.style.display = 'block';
                    confirmButton.textContent = 'OK';
                    setTimeout(() => {
                        // For alert, auto-focus on OK button
                        confirmButton.focus();
                    }, 100);
                } else if (type === 'confirm') {
                    // Confirm: Cancel and OK buttons
                    cancelButton.style.display = 'block';
                    confirmButton.style.display = 'block';
                    confirmButton.textContent = 'OK';
                    cancelButton.textContent = 'Zrušit';
                    setTimeout(() => {
                        // For confirm, focus on Cancel button
                        cancelButton.focus();
                    }, 100);
                } else if (type === 'prompt') {
                    // Prompt: Cancel and OK buttons
                    cancelButton.style.display = 'block';
                    confirmButton.style.display = 'block';
                    confirmButton.textContent = 'OK';
                    cancelButton.textContent = 'Zrušit';
                    setTimeout(() => {
                        // For prompt, focus on input field
                        inputField.focus();
                    }, 100);
                }

                // Store type for later reference
                this.currentType = type;
            }

            showModal() {
                const overlay = document.getElementById('custom-modal-overlay');
                const wrapper = document.getElementById('custom-modal-wrapper');
                const modal = document.getElementById('custom-modal');

                // Store previously focused element
                this.previouslyFocused = document.activeElement;

                // Show modal
                overlay.classList.remove('fade');
                wrapper.style.display = 'block';

                // Force reflow
                void overlay.offsetWidth;

                // Add fade effect
                overlay.classList.add('fade');
                overlay.style.display = 'block';

                modal.setAttribute('aria-hidden', 'false');
                modal.style.display = 'block';

                // Make sure modal is visible and focused
                // Trap focus inside modal initially
                this.trapFocus();
            }

            closeModal() {
                const overlay = document.getElementById('custom-modal-overlay');
                const wrapper = document.getElementById('custom-modal-wrapper');
                const modal = document.getElementById('custom-modal');

                // Hide modal
                overlay.classList.remove('fade');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                wrapper.style.display = 'none';
                overlay.style.display = 'none';

                // Restore focus to previously focused element
                if (this.previouslyFocused && typeof this.previouslyFocused.focus === 'function') {
                    this.previouslyFocused.focus();
                }

                // Clean up
                this.resolveCallback = null;
                this.rejectCallback = null;
                this.modalType = null;
            }

            handleConfirm() {
                if (this.modalType === 'prompt') {
                    const inputValue = document.getElementById('custom-modal-input').value;
                    if (this.resolveCallback) {
                        this.resolveCallback(inputValue);
                    }
                } else if (this.modalType === 'confirm' || this.modalType === 'alert') {
                    if (this.resolveCallback) {
                        this.resolveCallback(this.modalType === 'confirm' ? true : undefined);
                    }
                }
                this.closeModal();
            }

            handleCancel() {
                if (this.modalType === 'confirm') {
                    if (this.resolveCallback) {
                        this.resolveCallback(false);
                    }
                } else if (this.modalType === 'prompt') {
                    // For prompt, return null when cancelled
                    if (this.resolveCallback) {
                        this.resolveCallback(null);
                    }
                }
                this.closeModal();
            }

            trapFocus() {
                const modal = document.getElementById('custom-modal');
                const focusableElements = modal.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );

                if (focusableElements.length === 0) return;

                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                // Focus on first element if nothing is currently focused in the modal
                if (!modal.contains(document.activeElement)) {
                    firstElement.focus();
                }

                // Listen for Tab key to trap focus
                modal.addEventListener('keydown', (e) => {
                    if (e.key !== 'Tab') return;

                    if (e.shiftKey) {
                        // Shift + Tab pressed
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else {
                        // Tab pressed
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                });
            }
        }

        // Create singleton instance
        const modalManager = new ModalManager();

        // Global functions to replace native alerts
        function alert(message) {
            return modalManager.showAlert(message);
        }

        function confirm(message) {
            return modalManager.showConfirm(message);
        }

        // Note: prompt is not commonly replaced due to security concerns
        // In this application, we don't see any prompt() usage, so we won't implement it
        // If needed: function prompt(message, defaultValue = '') { return modalManager.showPrompt(message, 'Vstup', defaultValue); }

        // API base URL
        const API_BASE = 'http://localhost:5000/api';
        
        // DOM Elements
        const booksListEl = document.getElementById('books-list');
        const readersListEl = document.getElementById('readers-list');
        const bookSearchEl = document.getElementById('book-search');
        const genreFilterEl = document.getElementById('genre-filter');
        const readerSearchEl = document.getElementById('reader-search');
        const loanFormEl = document.getElementById('loan-form');
        const loanBookEl = document.getElementById('loan-book');
        const loanReaderEl = document.getElementById('loan-reader');
        const activeLoansListEl = document.getElementById('active-loans-list');
        const readerLoansHistoryEl = document.getElementById('reader-loans-history');
        const historyReaderSelectEl = document.getElementById('history-reader-select');
        const bookHistorySelectEl = document.getElementById('book-history-select');
        const viewBookHistoryBtnEl = document.getElementById('view-book-history-btn');
        const bookLoansHistoryEl = document.getElementById('book-loans-history');

        // Modal elements
        const bookModalEl = new bootstrap.Modal(document.getElementById('bookModal'));
        const bookFormEl = document.getElementById('book-form');
        const bookTitleEl = document.getElementById('book-title');
        const bookAuthorEl = document.getElementById('book-author');
        const bookYearEl = document.getElementById('book-year');
        const bookGenreEl = document.getElementById('book-genre');
        const bookAvailableEl = document.getElementById('book-available');
        const bookTotalEl = document.getElementById('book-total');
        const bookStateEl = document.getElementById('book-state');
        const bookIdEl = document.getElementById('book-id');

        const readerModalEl = new bootstrap.Modal(document.getElementById('readerModal'));
        const readerFormEl = document.getElementById('reader-form');
        const readerNameEl = document.getElementById('reader-name');
        const readerClassEl = document.getElementById('reader-class');
        const readerEmailEl = document.getElementById('reader-email');
        const readerIdEl = document.getElementById('reader-id');

        // Physical Books elements
        const physicalBookBookSelectEl = document.getElementById('physical-book-book-select');
        const loadPhysicalBooksBtnEl = document.getElementById('load-physical-books-btn');
        const addPhysicalBookBtnEl = document.getElementById('add-physical-book-btn');
        const physicalBooksContainerEl = document.getElementById('physical-books-container');
        const physicalBookModalEl = new bootstrap.Modal(document.getElementById('physicalBookModal'));
        const physicalBookFormEl = document.getElementById('physical-book-form');
        const physicalBookParentIdEl = document.getElementById('physical-book-parent-id');
        const physicalBookIdEl = document.getElementById('physical-book-id');
        const physicalBookStateEl = document.getElementById('physical-book-state');
        const physicalBookStatusEl = document.getElementById('physical-book-status');
        const savePhysicalBookBtnEl = document.getElementById('save-physical-book-btn');
        const physicalBookHistoryModalEl = new bootstrap.Modal(document.getElementById('physicalBookHistoryModal'));
        const physicalBookHistoryContentEl = document.getElementById('physical-book-history-content');
        const changePhysicalBookStateEl = document.getElementById('change-physical-book-state');
        const changePhysicalBookStatusEl = document.getElementById('change-physical-book-status');
        const updatePhysicalBookStateBtnEl = document.getElementById('update-physical-book-state-btn');


        // Current edit state
        let currentBook = null;
        let currentReader = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadBooks();
            loadReaders();
            loadActiveLoans();
            loadReadersForHistoryDropdown(); // Load readers for history dropdown
            loadBooksForHistoryDropdown(); // Load books for book history dropdown
            loadBooksForPhysicalBookForm(); // Load books for physical book dropdown

            // Event listeners
            document.getElementById('add-book-btn').addEventListener('click', openAddBookModal);
            document.getElementById('save-book-btn').addEventListener('click', saveBook);
            document.getElementById('add-reader-btn').addEventListener('click', openAddReaderModal);
            document.getElementById('save-reader-btn').addEventListener('click', saveReader);
            loanFormEl.addEventListener('submit', borrowBook);
            bookSearchEl.addEventListener('input', loadBooks);
            genreFilterEl.addEventListener('change', loadBooks);
            readerSearchEl.addEventListener('input', loadReaders);
            historyReaderSelectEl.addEventListener('change', handleReaderHistoryChange);
            viewBookHistoryBtnEl.addEventListener('click', handleViewBookHistory);

            // Load books and readers for loan form
            loadBooksForLoanForm();
            loadReadersForLoanForm();

            // Physical books event listeners
            loadPhysicalBooksBtnEl.addEventListener('click', loadPhysicalBooks);
            addPhysicalBookBtnEl.addEventListener('click', openAddPhysicalBookModal);
            savePhysicalBookBtnEl.addEventListener('click', savePhysicalBook);
            updatePhysicalBookStateBtnEl.addEventListener('click', updatePhysicalBookState);
        });


        // Helper function to get state label from value
        function getBookStateLabel(stateValue) {
            const stateLabels = {
                'new': 'Nová',
                'like_new': 'Jako nová',
                'good': 'Dobrá',
                'acceptable': 'Přijatelná',
                'poor': 'Slabá',
                'damaged': 'Poškozená'
            };
            return stateLabels[stateValue] || stateValue;
        }

        // Load books with filters
        async function loadBooks() {
            const searchTerm = bookSearchEl.value.trim();
            const genre = genreFilterEl.value;

            let url = `${API_BASE}/books`;
            const params = new URLSearchParams();

            if (searchTerm) params.append('search', searchTerm);
            if (genre) params.append('genre', genre);

            if (params.toString()) {
                url += '?' + params.toString();
            }

            try {
                const response = await fetch(url);
                const books = await response.json();

                booksListEl.innerHTML = '';
                books.forEach(book => {
                    // Format book state for display
                    const stateLabels = {
                        'new': 'Nová',
                        'like_new': 'Jako nová',
                        'good': 'Dobrá',
                        'acceptable': 'Přijatelná',
                        'poor': 'Slabá',
                        'damaged': 'Poškozená'
                    };
                    const stateDisplay = stateLabels[book.state] || book.state;

                    // Determine badge class based on state
                    let stateClass = 'bg-info';
                    if (book.state === 'new' || book.state === 'like_new') stateClass = 'bg-success';
                    else if (book.state === 'poor') stateClass = 'bg-warning';
                    else if (book.state === 'damaged') stateClass = 'bg-danger';

                    const bookCard = document.createElement('div');
                    bookCard.className = 'col-12';
                    bookCard.innerHTML = `
                        <div class="card book-card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h5>${book.title} <small class="text-muted">(${book._id.substring(0, 8)}...)</small></h5>
                                        <p class="text-muted mb-1"><strong>Autor:</strong> ${book.author}</p>
                                        <p class="text-muted mb-1"><strong>Rok:</strong> ${book.year}</p>
                                        <p class="text-muted mb-1"><strong>Žánr:</strong> ${book.genre}</p>
                                        <p><strong>Dostupné kopie:</strong> ${book.availableCopies}/${book.totalCopies}</p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editBook('${book._id}')">Upravit</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBook('${book._id}')">Smazat</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="viewPhysicalBooks('${book._id}')">Fyzické kopie</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    booksListEl.appendChild(bookCard);
                });
            } catch (error) {
                console.error('Error loading books:', error);
            }
        }
        
        // Load readers
        async function loadReaders() {
            const searchTerm = readerSearchEl.value.trim();
            
            let url = `${API_BASE}/readers`;
            if (searchTerm) {
                // Simple client-side filter for demo purposes
                try {
                    const response = await fetch(`${API_BASE}/readers`);
                    const allReaders = await response.json();
                    
                    const filteredReaders = allReaders.filter(reader => 
                        reader.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        reader.class.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        reader.email.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    
                    readersListEl.innerHTML = '';
                    filteredReaders.forEach(reader => {
                        const readerCard = document.createElement('div');
                        readerCard.className = 'col-12';
                        readerCard.innerHTML = `
                            <div class="card book-card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h5>${reader.name}</h5>
                                            <p class="text-muted mb-1"><strong>Třída:</strong> ${reader.class}</p>
                                            <p class="text-muted mb-1"><strong>Email:</strong> ${reader.email}</p>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editReader('${reader._id}')">Upravit</button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteReader('${reader._id}')">Smazat</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        readersListEl.appendChild(readerCard);
                    });
                } catch (error) {
                    console.error('Error loading readers:', error);
                }
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/readers`);
                const readers = await response.json();
                
                readersListEl.innerHTML = '';
                readers.forEach(reader => {
                    const readerCard = document.createElement('div');
                    readerCard.className = 'col-12';
                    readerCard.innerHTML = `
                        <div class="card book-card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h5>${reader.name}</h5>
                                        <p class="text-muted mb-1"><strong>Třída:</strong> ${reader.class}</p>
                                        <p class="text-muted mb-1"><strong>Email:</strong> ${reader.email}</p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editReader('${reader._id}')">Upravit</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteReader('${reader._id}')">Smazat</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    readersListEl.appendChild(readerCard);
                });
            } catch (error) {
                console.error('Error loading readers:', error);
            }
        }
        
        // Load active loans
        async function loadActiveLoans() {
            try {
                const response = await fetch(`${API_BASE}/loans/active`);
                const loans = await response.json();

                activeLoansListEl.innerHTML = '';
                if (loans.length === 0) {
                    activeLoansListEl.innerHTML = '<p>Nejsou žádné aktivní výpůjčky.</p>';
                    return;
                }

                loans.forEach(loan => {
                    // Extract book and reader details from populated fields
                    const bookTitle = loan.physicalBookId?.bookId?.title || 'N/A';
                    const bookAuthor = loan.physicalBookId?.bookId?.author || 'N/A';
                    const physicalBookId = loan.physicalBookId?.externalId || 'N/A';
                    const readerName = loan.readerId?.name || 'N/A';
                    const readerClass = loan.readerId?.class || 'N/A';

                    const loanCard = document.createElement('div');
                    loanCard.className = 'card mb-2 loan-active';
                    loanCard.innerHTML = `
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Kniha:</strong> ${bookTitle}<br>
                                    <strong>Autor:</strong> ${bookAuthor}<br>
                                    <strong>ID kopie:</strong> ${physicalBookId}
                                </div>
                                <div class="col-md-4">
                                    <strong>Čtenář:</strong> ${readerName}<br>
                                    <strong>Třída:</strong> ${readerClass}
                                </div>
                                <div class="col-md-2 text-end">
                                    <button class="btn btn-sm btn-warning" onclick="returnBook('${loan._id}')">Vrátit</button>
                                </div>
                            </div>
                        </div>
                    `;
                    activeLoansListEl.appendChild(loanCard);
                });
            } catch (error) {
                console.error('Error loading active loans:', error);
            }
        }
        
        // Load books for loan form
        async function loadBooksForLoanForm() {
            try {
                const response = await fetch(`${API_BASE}/books`);
                const books = await response.json();

                loanBookEl.innerHTML = '<option value="">Vyberte knihu...</option>';
                books.forEach(book => {
                    if (book.availableCopies > 0) {
                        const option = document.createElement('option');
                        option.value = book._id;
                        option.textContent = `${book.title} (${book.author}) - Dostupné: ${book.availableCopies}`;
                        loanBookEl.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error loading books for loan form:', error);
            }
        }
        
        // Load readers for loan form
        async function loadReadersForLoanForm() {
            try {
                const response = await fetch(`${API_BASE}/readers`);
                const readers = await response.json();
                
                loanReaderEl.innerHTML = '<option value="">Vyberte čtenáře...</option>';
                readers.forEach(reader => {
                    const option = document.createElement('option');
                    option.value = reader._id;
                    option.textContent = `${reader.name} (${reader.class})`;
                    loanReaderEl.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading readers for loan form:', error);
            }
        }
        
        // Borrow a book
        async function borrowBook(e) {
            e.preventDefault();

            const bookId = loanBookEl.value;
            const readerId = loanReaderEl.value;

            if (!bookId || !readerId) {
                await alert('Prosím vyberte knihu a čtenáře.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/loans`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ bookId, readerId })  // Backend will pick an available physical book
                });

                if (response.ok) {
                    await alert('Kniha byla úspěšně vypůjčena!');
                    loanFormEl.reset();
                    loadActiveLoans();
                    loadBooks();
                    loadBooksForLoanForm(); // Refresh available books
                } else {
                    const error = await response.json();
                    await alert(error.message || 'Chyba při vypůjčení knihy.');
                }
            } catch (error) {
                console.error('Error borrowing book:', error);
                await alert('Chyba při komunikaci se serverem.');
            }
        }
        
        // Return a book
        async function returnBook(loanId) {
            const confirmed = await confirm('Opravdu chcete vrátit tuto knihu?');
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/loans/${loanId}/return`, {
                    method: 'POST'
                });

                if (response.ok) {
                    await alert('Kniha byla úspěšně vrácena!');
                    loadActiveLoans();
                    loadBooks();
                    loadBooksForLoanForm(); // Refresh available books
                } else {
                    const error = await response.json();
                    await alert(error.message || 'Chyba při vrácení knihy.');
                }
            } catch (error) {
                console.error('Error returning book:', error);
                await alert('Chyba při komunikaci se serverem.');
            }
        }
        
        // Open add book modal
        function openAddBookModal() {
            bookFormEl.reset();
            bookIdEl.value = '';
            document.getElementById('bookModalLabel').textContent = 'Přidat knihu';
            bookModalEl.show();
        }
        
        // Edit book
        function editBook(id) {
            fetch(`${API_BASE}/books/${id}`)
                .then(response => response.json())
                .then(book => {
                    currentBook = book;
                    bookIdEl.value = book._id;
                    bookTitleEl.value = book.title;
                    bookAuthorEl.value = book.author;
                    bookYearEl.value = book.year;
                    bookGenreEl.value = book.genre;
                    bookAvailableEl.value = book.availableCopies;
                    bookTotalEl.value = book.totalCopies;
                    bookStateEl.value = book.state || 'good'; // Default to 'good' if no state set
                    document.getElementById('bookModalLabel').textContent = 'Upravit knihu';
                    bookModalEl.show();
                })
                .catch(error => console.error('Error fetching book:', error));
        }
        
        // Save book (add or update)
        async function saveBook() {
            const bookData = {
                title: bookTitleEl.value,
                author: bookAuthorEl.value,
                year: parseInt(bookYearEl.value),
                genre: bookGenreEl.value,
                totalCopies: parseInt(bookTotalEl.value)
            };

            try {
                let response;
                if (bookIdEl.value) {
                    // Update existing book
                    response = await fetch(`${API_BASE}/books/${bookIdEl.value}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(bookData)
                    });
                } else {
                    // Create new book
                    response = await fetch(`${API_BASE}/books`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(bookData)
                    });
                }

                if (response.ok) {
                    bookModalEl.hide();
                    // If it's a new book, create physical copies equal to totalCopies
                    if (!bookIdEl.value) {
                        const newBook = await response.json();
                        await createPhysicalBooks(newBook._id, bookData.totalCopies);
                    } else {
                        // If updating existing book, check if totalCopies changed and adjust physical books accordingly
                        const existingBook = await response.json();
                        await adjustPhysicalBooks(existingBook._id, bookData.totalCopies);
                    }
                    loadBooks();
                    loadBooksForLoanForm(); // Refresh the book list in loan form
                    loadBooksForPhysicalBookForm(); // Refresh the book list in physical book form
                    bookFormEl.reset();
                } else {
                    const error = await response.json();
                    await alert(error.message || 'Chyba při ukládání knihy.');
                }
            } catch (error) {
                console.error('Error saving book:', error);
                await alert('Chyba při komunikaci se serverem.');
            }
        }
        
        // Delete book
        async function deleteBook(id) {
            const confirmed = await confirm('Opravdu chcete smazat tuto knihu?');
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/books/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadBooks();
                    loadBooksForLoanForm(); // Refresh the book list in loan form
                    await alert('Kniha byla úspěšně smazána.');
                } else {
                    const error = await response.json();
                    await alert(error.message || 'Chyba při mazání knihy.');
                }
            } catch (error) {
                console.error('Error deleting book:', error);
                await alert('Chyba při komunikaci se serverem.');
            }
        }
        
        // Open add reader modal
        function openAddReaderModal() {
            readerFormEl.reset();
            readerIdEl.value = '';
            document.getElementById('readerModalLabel').textContent = 'Přidat čtenáře';
            readerModalEl.show();
        }
        
        // Edit reader
        function editReader(id) {
            fetch(`${API_BASE}/readers/${id}`)
                .then(response => response.json())
                .then(reader => {
                    currentReader = reader;
                    readerIdEl.value = reader._id;
                    readerNameEl.value = reader.name;
                    readerClassEl.value = reader.class;
                    readerEmailEl.value = reader.email;
                    document.getElementById('readerModalLabel').textContent = 'Upravit čtenáře';
                    readerModalEl.show();
                })
                .catch(error => console.error('Error fetching reader:', error));
        }
        
        // Save reader (add or update)
        async function saveReader() {
            const readerData = {
                name: readerNameEl.value,
                class: readerClassEl.value,
                email: readerEmailEl.value
            };

            try {
                let response;
                if (readerIdEl.value) {
                    // Update existing reader
                    response = await fetch(`${API_BASE}/readers/${readerIdEl.value}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(readerData)
                    });
                } else {
                    // Create new reader
                    response = await fetch(`${API_BASE}/readers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(readerData)
                    });
                }

                if (response.ok) {
                    readerModalEl.hide();
                    loadReaders();
                    loadReadersForLoanForm(); // Refresh the reader list in loan form
                    readerFormEl.reset();
                } else {
                    const error = await response.json();
                    await alert(error.message || 'Chyba při ukládání čtenáře.');
                }
            } catch (error) {
                console.error('Error saving reader:', error);
                await alert('Chyba při komunikaci se serverem.');
            }
        }
        
        // Delete reader
        async function deleteReader(id) {
            const confirmed = await confirm('Opravdu chcete smazat tohoto čtenáře?');
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/readers/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadReaders();
                    loadReadersForLoanForm(); // Refresh the reader list in loan form
                    loadReadersForHistoryDropdown(); // Refresh the history dropdown
                    await alert('Čtenář byl úspěšně smazán.');
                } else {
                    const error = await response.json();
                    await alert(error.message || 'Chyba při mazání čtenáře.');
                }
            } catch (error) {
                console.error('Error deleting reader:', error);
                await alert('Chyba při komunikaci se serverem.');
            }
        }

        // Load readers for history dropdown
        async function loadReadersForHistoryDropdown() {
            try {
                const response = await fetch(`${API_BASE}/readers`);
                const readers = await response.json();

                historyReaderSelectEl.innerHTML = '<option value="">Vyberte čtenáře...</option>';
                readers.forEach(reader => {
                    const option = document.createElement('option');
                    option.value = reader._id;
                    option.textContent = `${reader.name} (${reader.class})`;
                    historyReaderSelectEl.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading readers for history dropdown:', error);
            }
        }

        // Load books for book history dropdown
        async function loadBooksForHistoryDropdown() {
            try {
                const response = await fetch(`${API_BASE}/books`);
                const books = await response.json();

                bookHistorySelectEl.innerHTML = '<option value="">Vyberte knihu...</option>';
                books.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book._id;
                    option.textContent = `${book.title} (${book.author})`;
                    bookHistorySelectEl.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading books for history dropdown:', error);
            }
        }

        // Handle reader history selection change
        async function handleReaderHistoryChange() {
            const readerId = historyReaderSelectEl.value;

            if (!readerId) {
                readerLoansHistoryEl.innerHTML = '<p>Vyberte čtenáře pro zobrazení historie jeho výpůjček</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/readers/${readerId}/loans`);
                const loans = await response.json();

                if (loans.length === 0) {
                    readerLoansHistoryEl.innerHTML = '<p>Tento čtenář nemá žádné výpůjčky.</p>';
                    return;
                }

                let loansHtml = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Kniha</th><th>Autor</th><th>Datum vypůjčení</th><th>Datum vrácení</th><th>Status</th></tr></thead><tbody>';

                loans.forEach(loan => {
                    const borrowDate = new Date(loan.borrowDate).toLocaleDateString('cs-CZ');
                    const returnDate = loan.returnDate ? new Date(loan.returnDate).toLocaleDateString('cs-CZ') : 'Nevráceno';
                    const status = loan.returnDate ? 'Vráceno' : 'Vypůjčeno';
                    const statusClass = loan.returnDate ? 'table-success' : 'table-warning';

                    loansHtml += `
                        <tr class="${statusClass}">
                            <td>${loan.physicalBookId && loan.physicalBookId.bookId ? loan.physicalBookId.bookId.title : 'N/A'}</td>
                            <td>${loan.physicalBookId && loan.physicalBookId.bookId ? loan.physicalBookId.bookId.author : 'N/A'}</td>
                            <td>${borrowDate}</td>
                            <td>${returnDate}</td>
                            <td><span class="badge bg-${loan.returnDate ? 'success' : 'warning'}">${status}</span></td>
                        </tr>
                    `;
                });

                loansHtml += '</tbody></table></div>';
                readerLoansHistoryEl.innerHTML = loansHtml;
            } catch (error) {
                console.error('Error loading reader history:', error);
                readerLoansHistoryEl.innerHTML = '<p>Chyba při načítání historie výpůjček.</p>';
            }
        }

        // Handle view book history button click
        async function handleViewBookHistory() {
            const bookId = bookHistorySelectEl.value;

            if (!bookId) {
                bookLoansHistoryEl.innerHTML = '<p>Vyberte knihu a klikněte na "Zobrazit historii" pro zobrazení historie této knihy</p>';
                return;
            }

            try {
                // Get the book history combined with loans
                const historyResponse = await fetch(`${API_BASE}/books/${bookId}/history`);
                if (!historyResponse.ok) {
                    bookLoansHistoryEl.innerHTML = '<p>Kniha nebyla nalezena nebo nastala chyba.</p>';
                    return;
                }
                const historyData = await historyResponse.json();

                // Display book info and combined history
                let historyHtml = `<h5>Informace o knize: ${historyData.book.title}</h5>`;
                historyHtml += `<p><strong>Autor:</strong> ${historyData.book.author}</p>`;
                historyHtml += `<p><strong>Rok:</strong> ${historyData.book.year}</p>`;
                historyHtml += `<p><strong>Žánr:</strong> ${historyData.book.genre}</p>`;
                historyHtml += `<p><strong>Celkový počet kopií:</strong> ${historyData.physicalBooks ? historyData.physicalBooks.length : 0}</p>`;

                // Display history for each physical copy
                if (historyData.physicalBooks && historyData.physicalBooks.length > 0) {
                    historyHtml += '<h6 class="mt-4">Historie jednotlivých fyzických kopií:</h6>';

                    historyData.physicalBooks.forEach((physicalBook, index) => {
                        historyHtml += `<div class="card mt-3">
                            <div class="card-header">
                                <h6>Fyzická kopie #${index + 1}: ${physicalBook.externalId}
                                    <span class="badge ${getStateBadgeClass(physicalBook.state)} ml-2">${getBookStateLabel(physicalBook.state)}</span>
                                    <span class="badge ${getStatusBadgeClass(physicalBook.status)} ml-2">${getStatusLabel(physicalBook.status)}</span>
                                </h6>
                            </div>
                            <div class="card-body">`;

                        // Get history for this specific physical book
                        const physicalBookHistory = historyData.stateHistory.filter(h => h.bookId.toString() === physicalBook._id.toString());

                        // Also get loan/return records for this physical book
                        const loanRecords = historyData.loanHistory.filter(l => l.physicalBookId._id.toString() === physicalBook._id.toString());

                        // Combine all records and sort by date (newest first)
                        let allRecords = [];

                        // Add state changes
                        physicalBookHistory.forEach(record => {
                            allRecords.push({
                                timestamp: record.timestamp,
                                action: record.action,
                                previousState: record.previousState,
                                newState: record.newState,
                                note: record.note,
                                type: 'state_change'
                            });
                        });

                        // Add loan records
                        loanRecords.forEach(loan => {
                            allRecords.push({
                                timestamp: loan.borrowDate,
                                action: 'loan',
                                readerName: loan.readerId.name,
                                readerClass: loan.readerId.class,
                                type: 'loan',
                                loanId: loan._id
                            });
                        });

                        // Add return records for this book
                        loanRecords.filter(l => l.returnDate).forEach(loan => {
                            allRecords.push({
                                timestamp: loan.returnDate,
                                action: 'return',
                                readerName: loan.readerId.name,
                                type: 'return',
                                loanId: loan._id
                            });
                        });

                        if (allRecords.length > 0) {
                            historyHtml += '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>Datum</th><th>Typ</th><th>Popis</th></tr></thead><tbody>';

                            // Sort history by date (newest first)
                            const sortedHistory = [...allRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                            sortedHistory.forEach(record => {
                                let eventTypeLabel = '';
                                let eventTypeClass = '';
                                let description = '';

                                if (record.type === 'loan') {
                                    eventTypeLabel = 'Výpůjčka';
                                    eventTypeClass = 'table-warning';
                                    description = `Vypůjčeno čtenáři: ${record.readerName || 'N/A'} (${record.readerClass || 'N/A'})`;
                                } else if (record.type === 'return') {
                                    eventTypeLabel = 'Vrácení';
                                    eventTypeClass = 'table-success';
                                    description = `Vráceno čtenářem: ${record.readerName || 'N/A'}`;
                                } else if (record.type === 'state_change') {
                                    eventTypeLabel = 'Změna stavu';
                                    eventTypeClass = 'table-info';
                                    description = `Změna stavu z "${record.previousState ? getBookStateLabel(record.previousState) : 'N/A'}" na "${getBookStateLabel(record.newState)}"${record.note ? ` (${record.note})` : ''}`;
                                }

                                const dateFormatted = new Date(record.timestamp).toLocaleString('cs-CZ');

                                historyHtml += `
                                    <tr class="${eventTypeClass}">
                                        <td>${dateFormatted}</td>
                                        <td>${eventTypeLabel}</td>
                                        <td>${description}</td>
                                    </tr>
                                `;
                            });

                            historyHtml += '</tbody></table></div>';
                        } else {
                            historyHtml += '<p class="text-muted">Tato fyzická kopie nemá zatím žádnou historii.</p>';
                        }

                        historyHtml += '</div></div>';
                    });
                } else {
                    historyHtml += '<p class="text-muted">Tato kniha nemá žádné fyzické kopie.</p>';
                }

                bookLoansHistoryEl.innerHTML = historyHtml;
            } catch (error) {
                console.error('Error loading book history:', error);
                bookLoansHistoryEl.innerHTML = '<p>Chyba při načítání historie knihy.</p>';
            }
        }

        // Helper function to get appropriate badge class based on state
        function getStateBadgeClass(state) {
            switch (state) {
                case 'new':
                case 'like_new':
                    return 'bg-success';
                case 'good':
                    return 'bg-primary';
                case 'acceptable':
                    return 'bg-info';
                case 'poor':
                    return 'bg-warning';
                case 'damaged':
                    return 'bg-danger';
                default:
                    return 'bg-secondary';
            }
        }

        // Load books for physical book form dropdown
        async function loadBooksForPhysicalBookForm() {
            try {
                const response = await fetch(`${API_BASE}/books`);
                const books = await response.json();

                physicalBookBookSelectEl.innerHTML = '<option value="">Vyberte hlavní knihu...</option>';
                books.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book._id;
                    option.textContent = `${book.title} (${book.author})`;
                    physicalBookBookSelectEl.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading books for physical book form:', error);
            }
        }

        // Load physical books for a specific book
        async function loadPhysicalBooks() {
            const bookId = physicalBookBookSelectEl.value;

            if (!bookId) {
                await alert('Prosím vyberte hlavní knihu.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/books/${bookId}/physical`);
                const physicalBooks = await response.json();

                if (!response.ok) {
                    throw new Error(physicalBooks.message || 'Chyba při načítání fyzických kopií');
                }

                physicalBooksContainerEl.innerHTML = '';

                if (physicalBooks.length === 0) {
                    physicalBooksContainerEl.innerHTML = '<p>Pro tuto knihu neexistují žádné fyzické kopie.</p>';
                    return;
                }

                physicalBooks.forEach(pb => {
                    const pbCard = document.createElement('div');
                    pbCard.className = 'card mb-3';
                    pbCard.innerHTML = `
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>ID:</strong> ${pb.externalId}<br>
                                    <strong>Stav:</strong> <span class="badge ${getStateBadgeClass(pb.state)}">${getBookStateLabel(pb.state)}</span><br>
                                    <strong>Status:</strong> <span class="badge ${getStatusBadgeClass(pb.status)}">${getStatusLabel(pb.status)}</span>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-sm btn-outline-info" onclick="handlePhysicalBookHistory('${pb._id}', '${pb.externalId}', '${getBookStateLabel(pb.state)}', '${getStatusLabel(pb.status)}')">Historie</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="editPhysicalBook('${pb._id}', '${pb.bookId}', '${pb.state}', '${pb.status}')">Upravit</button>
                                </div>
                            </div>
                        </div>
                    `;
                    physicalBooksContainerEl.appendChild(pbCard);
                });
            } catch (error) {
                console.error('Error loading physical books:', error);
                await alert('Chyba při načítání fyzických kopií: ' + error.message);
            }
        }

        // Helper function to get status label
        function getStatusLabel(status) {
            const statusLabels = {
                'available': 'Dostupná',
                'borrowed': 'Vypůjčená',
                'damaged': 'Poškozená',
                'lost': 'Ztracená'
            };
            return statusLabels[status] || status;
        }

        // Helper function to get status badge class
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'available':
                    return 'bg-success';
                case 'borrowed':
                    return 'bg-warning';
                case 'damaged':
                    return 'bg-danger';
                case 'lost':
                    return 'bg-dark';
                default:
                    return 'bg-secondary';
            }
        }

        // Open add physical book modal
        async function openAddPhysicalBookModal() {
            const bookId = physicalBookBookSelectEl.value;

            if (!bookId) {
                await alert('Nejprve vyberte hlavní knihu.');
                return;
            }

            physicalBookFormEl.reset();
            physicalBookParentIdEl.value = bookId;
            physicalBookIdEl.value = '';
            document.getElementById('physicalBookModalLabel').textContent = 'Přidat fyzickou kopii';
            physicalBookModalEl.show();
        }

        // Edit physical book
        function editPhysicalBook(pbId, bookId, state, status) {
            physicalBookParentIdEl.value = bookId;
            physicalBookIdEl.value = pbId;
            physicalBookStateEl.value = state;
            physicalBookStatusEl.value = status;
            document.getElementById('physicalBookModalLabel').textContent = 'Upravit fyzickou kopii';
            physicalBookModalEl.show();
        }

        // Save physical book (add or update)
        async function savePhysicalBook() {
            const bookId = physicalBookParentIdEl.value;
            const pbId = physicalBookIdEl.value;

            const physicalBookData = {
                state: physicalBookStateEl.value,
                status: physicalBookStatusEl.value
            };

            try {
                let response;
                if (pbId) {
                    // Update existing physical book - this would require a custom endpoint
                    response = await fetch(`${API_BASE}/physical-books/${pbId}/state`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(physicalBookData)
                    });
                } else {
                    // Create new physical book
                    response = await fetch(`${API_BASE}/books/${bookId}/physical`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(physicalBookData)
                    });
                }

                if (response.ok) {
                    physicalBookModalEl.hide();
                    loadPhysicalBooks();
                } else {
                    const error = await response.json();
                    await alert(error.message || 'Chyba při ukládání fyzické kopie.');
                }
            } catch (error) {
                console.error('Error saving physical book:', error);
                await alert('Chyba při komunikaci se serverem.');
            }
        }

        // View physical book history
        async function viewPhysicalBookHistory(pbId, externalId, state, status) {
            try {
                const response = await fetch(`${API_BASE}/physical-books/${pbId}/history`);
                const historyData = await response.json();

                if (!response.ok) {
                    throw new Error(historyData.message || 'Chyba při načítání historie');
                }

                // Load the history data into the modal
                let historyHtml = `
                    <h5>Fyzická kopie: ${externalId}</h5>
                    <p><strong>Stav:</strong> <span class="badge ${getStateBadgeClass(historyData.physicalBook.state)}">${getBookStateLabel(historyData.physicalBook.state)}</span></p>
                    <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(historyData.physicalBook.status)}">${getStatusLabel(historyData.physicalBook.status)}</span></p>
                    <hr>
                `;

                if (historyData.stateHistory && historyData.stateHistory.length > 0) {
                    historyHtml += '<h6>Historie změn:</h6>';
                    historyHtml += '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>Datum</th><th>Typ</th><th>Popis</th></tr></thead><tbody>';

                    historyData.stateHistory.forEach(change => {
                        const changeDate = new Date(change.timestamp).toLocaleString('cs-CZ');
                        const description = `Změna z "${change.previousState ? getBookStateLabel(change.previousState) : 'N/A'}" na "${getBookStateLabel(change.newState)}"${change.note ? ` (${change.note})` : ''}`;

                        historyHtml += `
                            <tr>
                                <td>${changeDate}</td>
                                <td><span class="badge bg-info">Změna stavu</span></td>
                                <td>${description}</td>
                            </tr>
                        `;
                    });

                    historyHtml += '</tbody></table></div>';
                } else {
                    historyHtml += '<p>Tato fyzická kopie nemá zatím žádnou historii.</p>';
                }

                physicalBookHistoryContentEl.innerHTML = historyHtml;

                // Set up the state update form with the current values
                changePhysicalBookStateEl.value = historyData.physicalBook.state;
                changePhysicalBookStatusEl.value = historyData.physicalBook.status;
                updatePhysicalBookStateBtnEl.onclick = () => updatePhysicalBookStateFromHistoryModal(pbId);

                physicalBookHistoryModalEl.show();
            } catch (error) {
                console.error('Error loading physical book history:', error);
                await alert('Chyba při načítání historie fyzické kopie: ' + error.message);
            }
        }

        // Update physical book state from history modal
        async function updatePhysicalBookStateFromHistoryModal(pbId) {
            const newState = changePhysicalBookStateEl.value;
            const newStatus = changePhysicalBookStatusEl.value;

            const confirmed = await confirm(`Opravdu chcete změnit stav fyzické kopie?`);
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/physical-books/${pbId}/state`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        state: newState,
                        status: newStatus,
                        note: `Aktualizace z rozhraní - změna stavu na ${getBookStateLabel(newState)}, status na ${getStatusLabel(newStatus)}`
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    await alert('Stav fyzické kopie byl úspěšně změněn.');
                    physicalBookHistoryModalEl.hide();
                    loadPhysicalBooks(); // Refresh the list
                } else {
                    await alert(result.message || 'Chyba při změně stavu fyzické kopie.');
                }
            } catch (error) {
                console.error('Error updating physical book state:', error);
                await alert('Chyba při komunikaci se serverem.');
            }
        }

        // Function to create multiple physical books at once
        async function createPhysicalBooks(bookId, count) {
            // Create each physical book one by one
            for (let i = 0; i < count; i++) {
                try {
                    await fetch(`${API_BASE}/books/${bookId}/physical`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            state: 'good', // Default state
                            status: 'available' // Default status
                        })
                    });
                } catch (error) {
                    console.error('Error creating physical book:', error);
                }
            }
        }

        // Function to adjust physical books count to match the totalCopies
        async function adjustPhysicalBooks(bookId, targetCount) {
            try {
                // Get current physical books count
                const response = await fetch(`${API_BASE}/books/${bookId}/physical`);
                const currentPhysicalBooks = await response.json();

                const currentCount = currentPhysicalBooks.length;

                if (targetCount > currentCount) {
                    // Need to create more physical books
                    const countToAdd = targetCount - currentCount;
                    for (let i = 0; i < countToAdd; i++) {
                        await fetch(`${API_BASE}/books/${bookId}/physical`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                state: 'good', // Default state
                                status: 'available' // Default status
                            })
                        });
                    }
                } else if (targetCount < currentCount) {
                    // Need to remove some physical books (only if they are available)
                    const countToRemove = currentCount - targetCount;
                    for (let i = 0; i < countToRemove; i++) {
                        // Find an available physical book to delete
                        const availableBook = currentPhysicalBooks.find(pb => pb.status === 'available');
                        if (availableBook) {
                            await fetch(`${API_BASE}/physical-books/${availableBook._id}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error adjusting physical books:', error);
            }
        }

        // Wrapper function to update physical book state
        async function updatePhysicalBookState() {
            const pbId = physicalBookIdEl.value;
            if (pbId) {
                // If we have a pbId, this function was called from the edit modal
                // We should handle it differently, but since we already handle
                // updates in savePhysicalBook, we just need to avoid conflicts
                return;
            }
            // If no pbId, it could be called from somewhere else, though currently not used that way
        }

        // Function to handle physical book history with async/await
        async function handlePhysicalBookHistory(pbId, externalId, state, status) {
            await viewPhysicalBookHistory(pbId, externalId, state, status);
        }

        // Function to switch to the physical books tab and populate with a specific book
        function viewPhysicalBooks(bookId) {
            // Switch to the physical books tab
            const physicalBooksTab = document.getElementById('physical-books-tab');
            const physicalBooksTabInstance = new bootstrap.Tab(physicalBooksTab);
            physicalBooksTabInstance.show();

            // Set the book in the dropdown
            physicalBookBookSelectEl.value = bookId;

            // Load the physical books for this book
            loadPhysicalBooks();
        }
    </script>
</body>
</html>